<!DOCTYPE html>
<html lang="es" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administración - BettSoft</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
    rel="stylesheet"
  />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#003366",
            "background-light": "#F0F2F5",
          },
          fontFamily: {
            display: ["Public Sans", "sans-serif"],
          },
          borderRadius: {
            lg: "1rem",
          },
        },
      },
    };
  </script>
</head>

<body class="font-display bg-background-light text-slate-800 antialiased">
  <div class="min-h-screen flex flex-col">

    <!-- HEADER azul con menú -->
    <header class="bg-primary text-white shadow-md">
      <!-- Barra superior -->
      <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">

        <!-- Logo -->
        <a href="index.html" class="flex items-center">
          <img
            src="images/logo.png"
            alt="Logo FES Acatlán"
            class="h-10 sm:h-14 w-auto"
          />
        </a>

        <!-- Menú de escritorio -->
        <nav class="hidden sm:flex gap-8 text-sm md:text-base">
          <a href="index.html"
             class="pb-1 border-b-2 border-transparent hover:border-white transition">
            Inicio
          </a>
          <a href="reportar.html"
             class="pb-1 border-b-2 border-transparent hover:border-white transition">
            Nuevo reporte
          </a>
          <a href="consultar.html"
             class="pb-1 border-b-2 border-transparent hover:border-white transition">
            Consultar reporte
          </a>
        </nav>

        <!-- Botón Cerrar sesión (solo escritorio) -->
        <button
          type="button"
          class="hidden sm:inline-flex items-center gap-2 text-white text-sm font-medium
                 hover:shadow-md hover:bg-white/10 px-3 py-2 rounded-md transition"
        >
          <span class="material-icons text-base">logout</span>
          <span>Cerrar sesión</span>
        </button>

        <!-- Botón hamburguesa (solo móvil) -->
        <button
          type="button"
          class="inline-flex items-center justify-center sm:hidden p-2 rounded-md hover:bg.white/10 transition"
          onclick="toggleMobileMenu()"
          aria-label="Abrir menú"
        >
          <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none"
               viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>

      <!-- Menú móvil desplegable -->
      <div id="mobile-menu"
           class="sm:hidden hidden border-t border-white/20 bg-primary/95">
        <nav class="flex flex-col px-4 py-3 gap-3 text-sm">
          <a href="index.html"
             class="py-1 border-b border-white/10">
            Inicio
          </a>
          <a href="reportar.html"
             class="py-1 border-b border-white/10">
            Nuevo reporte
          </a>
          <a href="consultar.html"
             class="py-1 border-b border-white/10">
            Consultar reporte
          </a>
          <button
            type="button"
            class="pt-2 flex items-center gap-2 text-left"
          >
            <span class="material-icons text-base">logout</span>
            <span>Cerrar sesión</span>
          </button>
        </nav>
      </div>
    </header>

    <!-- CONTENIDO -->
    <main class="flex-1 px-4 py-8 sm:px-6 lg:px-8">
      <div class="mx-auto max-w-6xl space-y-8">

        <!-- Título -->
        <section class="text-center">
          <h1 class="text-3xl font-bold text-primary mb-2">
            Panel de administración
          </h1>
          <p class="text-slate-600">
            Gestiona los reportes de sanitarios de la FES Acatlán
          </p>
        </section>

        <!-- Filtros -->
        <section class="bg-white rounded-lg shadow-sm p-4">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
            <div>
              <label for="search-folio" class="block text-sm font-medium text-slate-700">
                Buscar por folio
              </label>
              <input
                id="search-folio"
                type="text"
                placeholder="#FES12345"
                class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm
                       focus:border-primary focus:ring-primary"
              />
            </div>

            <div>
              <label for="status-filter" class="block text-sm font-medium text-slate-700">
                Estado
              </label>
              <select
                id="status-filter"
                class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm
                       focus:border-primary focus:ring-primary"
              >
                <option value="Todos">Todos</option>
                <option value="Pendiente">Pendiente</option>
                <option value="En proceso">En proceso</option>
                <option value="Resuelto">Resuelto</option>
              </select>
            </div>

            <div>
              <label for="building-filter" class="block text-sm font-medium text-slate-700">
                Edificio
              </label>
              <select
                id="building-filter"
                class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm
                       focus:border-primary focus:ring-primary"
              >
                <option value="Todos">Todos</option>
                <!-- por ahora solo mostramos el id_bano, luego pueden mapear a edificios reales -->
                <option value="1">Baño 1</option>
                <option value="2">Baño 2</option>
                <option value="3">Baño 3</option>
              </select>
            </div>

            <button
              id="clear-filters"
              type="button"
              class="text-sm text-slate-500 hover:text-primary mt-6 text-left lg:text-right"
            >
              Limpiar filtros
            </button>
          </div>
        </section>

        <!-- LISTA DE REPORTES (dinámica) -->
        <section id="reports-container" class="space-y-4">
          <!-- Aquí se insertan las tarjetas desde JavaScript -->
        </section>

      </div>
    </main>
  </div>

  <!-- JS embebido -->
    <!-- JS embebido -->
  <script>
    // Menú móvil
    function toggleMobileMenu() {
      const menu = document.getElementById("mobile-menu");
      if (menu) menu.classList.toggle("hidden");
    }

    // ======================
    // CONFIG
    // ======================
    const API_BASE = "http://127.0.0.1:8000";
    let allReportes = [];

    // ======================
    // UTILIDADES
    // ======================
    function mapEstado(id) {
      if (id === 1) return "Pendiente";
      if (id === 2) return "En proceso";
      if (id === 3) return "Resuelto";
      return "Desconocido";
    }

    function estadoBadgeClasses(id) {
      if (id === 1) {
        return "inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-800";
      }
      if (id === 2) {
        return "inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800";
      }
      if (id === 3) {
        return "inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800";
      }
      return "inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-800";
    }

    function formatFecha(isoString) {
      if (!isoString) return "-";
      const d = new Date(isoString);
      if (Number.isNaN(d.getTime())) return isoString;
      const dia = String(d.getDate()).padStart(2, "0");
      const mes = String(d.getMonth() + 1).padStart(2, "0");
      const ano = d.getFullYear();
      const hora = String(d.getHours()).padStart(2, "0");
      const min = String(d.getMinutes()).padStart(2, "0");
      return `${dia}/${mes}/${ano} ${hora}:${min}`;
    }

    // ======================
    // ACTUALIZAR ESTADO EN BACKEND
    // ======================
    async function actualizarEstado(folio, nuevoEstado) {
      try {
        const resp = await fetch(
          `${API_BASE}/admin/reportes/${encodeURIComponent(folio)}/estado`,
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id_estado: nuevoEstado }),
          }
        );

        if (!resp.ok) {
          console.error(
            "Error al actualizar estado:",
            resp.status,
            await resp.text()
          );
          alert("No se pudo actualizar el estado del reporte. Intenta nuevamente.");
          return false;
        }

        return true;
      } catch (err) {
        console.error("Error de conexión al actualizar estado:", err);
        alert("Error de conexión con el servidor al actualizar estado.");
        return false;
      }
    }

    // ======================
    // RENDER DE TARJETAS
    // ======================
    function renderReportes(reportes) {
      const container = document.getElementById("reports-container");
      container.innerHTML = "";

      if (!reportes || reportes.length === 0) {
        container.innerHTML = `
          <p class="text-center text-slate-500 text-sm">
            No hay reportes para mostrar. Ajusta los filtros o intenta de nuevo.
          </p>`;
        return;
      }

      reportes.forEach((r) => {
        const estadoTexto = mapEstado(r.id_estado);
        const estadoClasses = estadoBadgeClasses(r.id_estado);
        const fecha = formatFecha(r.fecha_creacion);
        const ubicacion = `Baño #${r.id_bano}`;

        const card = document.createElement("article");
        card.className = "bg-white rounded-lg shadow-sm overflow-hidden";

        card.innerHTML = `
          <header class="p-4 border-b border-slate-200 flex justify-between items-center">
            <h2 class="font-semibold text-slate-900">
              Reporte #${r.folio}
            </h2>
            <div class="flex items-center gap-2">
              <span class="${estadoClasses}" data-estado-label>
                ${estadoTexto}
              </span>

              <select
                class="border border-slate-300 rounded-md text-xs px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-primary"
                data-folio="${r.folio}"
              >
                <option value="1" ${r.id_estado === 1 ? "selected" : ""}>Pendiente</option>
                <option value="2" ${r.id_estado === 2 ? "selected" : ""}>En proceso</option>
                <option value="3" ${r.id_estado === 3 ? "selected" : ""}>Resuelto</option>
              </select>
            </div>
          </header>

          <div class="p-4 grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
            <div>
              <p class="font-medium text-slate-500">Fecha de reporte</p>
              <p class="text-slate-900">${fecha}</p>
            </div>
            <div>
              <p class="font-medium text-slate-500">Número de cuenta</p>
              <p class="text-slate-900">${r.numero_cuenta || "-"}</p>
            </div>
            <div>
              <p class="font-medium text-slate-500">Prioridad</p>
              <p class="text-slate-900 capitalize">${r.prioridad_asignada || "-"}</p>
            </div>
            <div>
              <p class="font-medium text-slate-500">Ubicación</p>
              <p class="text-slate-900">${ubicacion}</p>
            </div>
          </div>
        `;

        const selectEstado = card.querySelector("select[data-folio]");
        const badge = card.querySelector("[data-estado-label]");

        selectEstado.addEventListener("change", async (e) => {
          const nuevo = parseInt(e.target.value, 10);
          const folio = e.target.getAttribute("data-folio");
          const anterior = r.id_estado;

          const ok = await actualizarEstado(folio, nuevo);
          if (!ok) {
            e.target.value = String(anterior);
            return;
          }

          r.id_estado = nuevo;

          const nuevoTexto = mapEstado(nuevo);
          const nuevasClases = estadoBadgeClasses(nuevo);
          badge.textContent = nuevoTexto;
          badge.className = nuevasClases;
        });

        container.appendChild(card);
      });
    }

    // ======================
    // FILTROS
    // ======================
    function aplicarFiltros() {
      const folioInput = document.getElementById("search-folio");
      const estadoSelect = document.getElementById("status-filter");
      const buildingSelect = document.getElementById("building-filter");

      const folioTexto = (folioInput.value || "").trim();
      const estadoTexto = estadoSelect.value || "Todos";
      const edificioVal = buildingSelect.value || "Todos";

      let filtrados = [...allReportes];

      if (folioTexto !== "") {
        filtrados = filtrados.filter((r) =>
          String(r.folio).includes(folioTexto)
        );
      }

      if (estadoTexto !== "Todos") {
        filtrados = filtrados.filter(
          (r) => mapEstado(r.id_estado) === estadoTexto
        );
      }

      if (edificioVal !== "Todos") {
        filtrados = filtrados.filter(
          (r) => String(r.id_bano) === String(edificioVal)
        );
      }

      renderReportes(filtrados);
    }

    function limpiarFiltros() {
      document.getElementById("search-folio").value = "";
      document.getElementById("status-filter").value = "Todos";
      document.getElementById("building-filter").value = "Todos";
      aplicarFiltros();
    }

    // ======================
    // CARGA INICIAL
    // ======================
    async function cargarReportes() {
      try {
        const resp = await fetch(`${API_BASE}/admin/reportes`);
        if (!resp.ok) {
          console.error("Error HTTP al cargar reportes:", resp.status);
          renderReportes([]);
          return;
        }
        const data = await resp.json();
        allReportes = Array.isArray(data) ? data : [];
        aplicarFiltros();
      } catch (err) {
        console.error("Error al cargar reportes:", err);
        renderReportes([]);
      }
    }

    // ======================
    // INIT
    // ======================
    document.addEventListener("DOMContentLoaded", () => {
      cargarReportes();

      document
        .getElementById("search-folio")
        .addEventListener("input", aplicarFiltros);
      document
        .getElementById("status-filter")
        .addEventListener("change", aplicarFiltros);
      document
        .getElementById("building-filter")
        .addEventListener("change", aplicarFiltros);
      document
        .getElementById("clear-filters")
        .addEventListener("click", limpiarFiltros);
    });

    async function cambiarEstado(folio, nuevoEstado) {
  try {
    const res = await fetch(`http://127.0.0.1:8000/admin/reportes/${folio}/estado`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        id_estado: nuevoEstado
      })
    });

    if (!res.ok) {
      throw new Error("No se pudo actualizar");
    }

    alert("Estado actualizado correctamente");
    cargarReportes(); // refrescar lista

  } catch (error) {
    console.error(error);
    alert("No se pudo actualizar el estado del reporte.");
  }
}

  </script>

</body>
</html>
